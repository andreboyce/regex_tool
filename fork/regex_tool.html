<!DOCTYPE html>
<html>
  <head>
    <title>Regex Tool</title>
    <meta content='text/html;charset=utf-8' http-equiv='Content-Type' />
    <style>
      h1{ text-align: center; }
      .profile_container{ display: flex; margin: 0px auto; border: 0px solid black; width: 90%; clear: both; }
      .profile_name{ width: 32%; text-align: center; padding: 5px 5px 5px 5px; }
      .input_profile_name{ padding: 5px 5px 5px 5px; }
      .load_profile{ width: 50%; text-align: center; padding: 5px 5px 5px 5px; }
      .save_profile{ width: 50%; text-align: center; padding: 5px 5px 5px 5px; }
      .input_pattern{ padding: 5px 5px 5px 5px; }
      .input_replace{ padding: 5px 5px 5px 5px; }
      .regex_pair{ display: flex; margin: 0px auto; border: 0px solid black; width: 90%; clear: both; }
      .pattern{ width: 95%; text-align: center; padding: 5px 5px 5px 5px; }
      .replace{ width: 95%; text-align: center; padding: 5px 5px 5px 5px; }
      .input_pattern{ padding: 5px 5px 5px 5px; }
      .input_replace{ padding: 5px 5px 5px 5px; }
      .controls{ width: 100%; text-align: center; }
      .tool_container{ display: flex; border: 0px solid black; }
      .panel{ text-align: center; width: 50%; }
      .textarea_tool{ width: 95%; height: 150px; }
      .textarea_profile{ display: none; }
    </style>

    <!--
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      $(document).ready(function() {
      });
    </script>
    -->

    <script>
      defaultProfileName = 'profile.default';

      // generateProfile();
      window.onload = function() {
        init();
      }

      function init() {
        let textarea_sourceElement = document.getElementById('textarea_source');
        if (textarea_sourceElement !== null) {
          textarea_sourceElement.value = '';
        }

        let textarea_resultElement = document.getElementById('textarea_result');
        if (textarea_resultElement !== null) {
          textarea_resultElement.value = '';
        }

        let input_profile_nameElement = document.getElementById('input_profile_name');
        if (input_profile_nameElement !== null) {
          input_profile_nameElement.value = '';
        }

        let input_patternElements = document.getElementsByClassName('input_pattern');
        if (input_patternElements.length > 0) {
          for (let i = 0; i < input_patternElements.length; i += 1) {
            input_patternElements[i].value = '';
          }
        }

        let input_replaceElements = document.getElementsByClassName('input_replace');
        if (input_replaceElements.length > 0) {
          for (let i = 0; i < input_replaceElements.length; i += 1) {
            input_replaceElements[i].value = '';
          }
        }

        loadProfileList();
        loadProfileFromLocalStorage();
      }

      function loadProfileList(selectedKey = '') {
        removeOptions();
        const items = { ...localStorage };
        let selectElement = document.getElementById('select_profile');
        if (selectElement !== null) {
          if (items !== null) {
            for (let key in items) {
              let keyMatch = key.match(/(profile\.)(.*)/g);
              if (keyMatch !== null) {
                if (key.match(/profile\.default/g)) {
                  continue;
                }
                let optionElement = document.createElement('option');
                if (selectedKey === key) {
                  optionElement.selected = 'selected';
                }
                optionElement.value = key;
                optionElement.innerHTML = key;
                selectElement.appendChild(optionElement);
              }
            }
          }
        }
      }

      function buttonNewPattern(patternEntry = { pattern: '', replace: '' }) {
        let regex_pairs = document.getElementsByClassName('regex_pair');
        if (regex_pairs.length > 0) {
          let clone = regex_pairs[regex_pairs.length-1].cloneNode(true);

          let input_patternElement = clone.getElementsByClassName('input_pattern');
          let input_replaceElement = clone.getElementsByClassName('input_replace');
          if (input_patternElement.length > 0) {
            input_patternElement[0].value = patternEntry.pattern;
          }
          if (input_replaceElement.length > 0) {
            input_replaceElement[0].value = patternEntry.replace;
          }

          regex_pairs[regex_pairs.length-1].after(clone);
        }
      }

      function buttonReplaceLastPattern() {
        let regex_pairs = document.getElementsByClassName('regex_pair');
        if (regex_pairs.length > 1) {
          regex_pairs[regex_pairs.length-1].remove();
        }
      }

      function buttonExecutePatternReplace() {
        let patternArray = [];
        let textarea_sourceElement = document.getElementById('textarea_source');
        let textarea_resultElement = document.getElementById('textarea_result');

        let regex_pairs = document.getElementsByClassName('regex_pair');
        if (regex_pairs.length > 0) {
          for (let i=0; i<regex_pairs.length ; i += 1) {
            let pattern = '';
            let replace = '';
            
            let patternElement = regex_pairs[i].getElementsByClassName('input_pattern');
            if (patternElement.length > 0) {
              // pattern = patternElement[0].value;
              // pattern = pattern.toString();
              pattern = new RegExp(patternElement[0].value, 'gm');
            }

            let replaceElement = regex_pairs[i].getElementsByClassName('input_replace');
            if (replaceElement.length > 0) {
              replace = replaceElement[0].value;
            }

            let patternReplace = { 'pattern': pattern, 'replace': replace };
            patternArray.push(patternReplace);
          }
        }

        if (textarea_resultElement !== null && textarea_sourceElement !== null) {
          let result = textarea_sourceElement.value;
          for ( let c = 0; c<patternArray.length ; c += 1) {
            result = result.replaceAll(patternArray[c].pattern, patternArray[c].replace);
          }
          textarea_resultElement.value = result;
        }
      }

      function generateProfile(profileName = null) {
        let regexProfile = {};
        let patternArray = [];
        let textarea_sourceElement = document.getElementById('textarea_source');
        let textarea_resultElement = document.getElementById('textarea_result');

        if (profileName === null) {
          profileName = defaultProfileName;
        }

        let regex_pairs = document.getElementsByClassName('regex_pair');
        if (regex_pairs.length > 0) {
          for (let i=0; i<regex_pairs.length ; i += 1) {
            let pattern = '';
            let replace = '';
            
            let patternElement = regex_pairs[i].getElementsByClassName('input_pattern');
            if (patternElement.length > 0) {
              // pattern = new RegExp(patternElement[0].value, 'gm');
              pattern = patternElement[0].value;
            }

            let replaceElement = regex_pairs[i].getElementsByClassName('input_replace');
            if (replaceElement.length > 0) {
              replace = replaceElement[0].value;
            }

            let patternReplace = { 'pattern': pattern, 'replace': replace };
            patternArray.push(patternReplace);
          }
          
          regexProfile.profileName = profileName;
          regexProfile.patternArray = patternArray;
          regexProfile.source = textarea_sourceElement.value;
        }

        return regexProfile;
      }

      function saveProfileToLocalStorage(profileName = '') {
        if (profileName === null || profileName === undefined || profileName === '') {
          let input_profile_nameElement = document.getElementById('input_profile_name');
          if (input_profile_nameElement !== null) {
            if (input_profile_nameElement.value === '' || input_profile_nameElement.value === null) {
              // profileName = defaultProfileName;
              let select_profileElement = document.getElementById('select_profile');
              if (select_profileElement !== null) {
                profileName = select_profileElement.value;
              } else {
               profileName = defaultProfileName;
              }
            } else {
              profileName = `profile.${input_profile_nameElement.value}`;
            }
          } else {
            profileName = defaultProfileName;
          }
        }

        let regexProfile = generateProfile(profileName);
        localStorage.setItem(profileName, `${JSON.stringify(regexProfile)}`);
        loadProfileList(profileName);
      }

      function loadProfileFromLocalStorage(profileName = '') {
        let select_profileElement = document.getElementById('select_profile');

        if (profileName === null || profileName === undefined || profileName === '') {
          profileName = select_profileElement.value;
        }

        let regexProfile = localStorage.getItem(profileName);

        if (regexProfile) {
          regexProfile = JSON.parse(regexProfile);
        }

        clearPatterns();

        if (regexProfile !== null && regexProfile !== undefined) {
          if (regexProfile.patternArray !== null) {
            let patternArray = regexProfile.patternArray;
            for (let i = 0; i<patternArray.length; i += 1) {
              buttonNewPattern(patternArray[i]);
            }
            // remove first pair
            let regex_pairs = document.getElementsByClassName('regex_pair');
            if (regex_pairs.length > 0) {
              regex_pairs[0].remove();
            }
          }
        }

        let textarea_sourceElement = document.getElementById('textarea_source');
        if (textarea_sourceElement !== null) {
          if (regexProfile !== null && regexProfile !== undefined) {
            textarea_sourceElement.value = regexProfile.source;
          }
        }
      }

      function clearPatterns() {
        let regex_pairs = document.getElementsByClassName('regex_pair');
        if (regex_pairs.length > 1) {
          
          let input_patternElement = regex_pairs[0].getElementsByClassName('input_pattern');
          if (input_patternElement !== null) {
            input_patternElement.value = '';
          }
          let input_replaceElement = regex_pairs[0].getElementsByClassName('input_replace');
          if (input_replaceElement !== null) {
            input_replaceElement.value = '';
          }

          while (regex_pairs.length > 1) {
            regex_pairs[regex_pairs.length-1].remove();
          }
        }
      }

      function removeOptions() {
        let select_profileElement = document.getElementById('select_profile');
        if (select_profileElement !== null) {
          let selectProfileLength = select_profileElement.options.length;
          for (let i = selectProfileLength-1; i > 0 ; i -= 1) {
            select_profileElement.options[i].remove();
          }
        }
      }

      function deleteProfile(profileName = '') {
        if (profileName === '' || profileName === null || profileName === undefined) {
          let select_profileElement = document.getElementById('select_profile');
          if (select_profileElement !== null) {
            profileName = select_profileElement.value;
            localStorage.removeItem(profileName);
            clearPatterns();
          }
        } else {
          localStorage.removeItem(profileName);
          clearPatterns();
        }
      }

      /**
      * Saves a .txt text file from from the contents of a textarea.
      * @param {string} textarea_id - textarea field id.
      */
      function download(textarea_id, fileName = '')
      {
         //console.log( "textarea_id: " + textarea_id );
         let text = document.getElementById( textarea_id ).value;
         text = text.replace(/\n/g, "\r\n"); // To retain the Line breaks.
         let blob = new Blob([text], { type: "text/plain"});
         let anchor = document.createElement("a");
         if (fileName === null || fileName === undefined || fileName === '') {
           anchor.download = textarea_id+".txt";
         } else {
           anchor.download = fileName+".txt";
         }
         anchor.href = window.URL.createObjectURL(blob);
         anchor.target ="_blank";
         anchor.style.display = "none";
         document.body.appendChild(anchor);
         anchor.click();
         document.body.removeChild(anchor);
      }

      function saveProfileToFile() {
        let profile = JSON.stringify(generateProfile());
        let textarea_profileElement = document.getElementById('textarea_profile');
        if (textarea_profileElement !== null) {
          textarea_profileElement.value = profile;

          let select_profileElement = document.getElementById('select_profile');
          if (select_profileElement !== null) {
            profileName = select_profileElement.value;
          } else {
            profileName = defaultProfileName;
          }
          download('textarea_profile', profileName);
        }
      }

      async function loadProfileFromFile(inputFileElement = null) {
        if (inputFileElement !== null) {
          if (inputFileElement.files.length) {
            let contents = await readFile(inputFileElement.files[0]);
            let fileName = inputFileElement.files[0].name;
            let extension = '';
            let fileNameMatch = fileName.match(/(.+)(\..*)/);
            if (fileNameMatch.length > 1) {
              fileName = fileNameMatch[1];
            }
            if (fileNameMatch.length > 2) {
              extension = fileNameMatch[2];
            }

            let profileName = '';

            let profileNameMatch = fileName.match(/^(profile\..+)/);

            if (profileNameMatch !== null) {
              if (profileNameMatch.length > 1) {
                profileName = profileNameMatch[1];
              } else {
                profileName = `profile.${fileName}`;
              }
            } else {
              profileName = `profile.${fileName}`;
            }

            // console.log(`profileName: ${profileName}`);

            let regexProfile = contents;            
            console.log(`regexProfile: ${regexProfile}`);
            localStorage.setItem(profileName, `${regexProfile}`);
            loadProfileList(profileName);
            loadProfileFromLocalStorage(profileName);
          }
        }
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          let fr = new FileReader();
          fr.onload = x=> resolve(fr.result);
          fr.readAsText(file);
        });
      }
    </script>
  </head>
  <body>
    <h1>Regex Tool</h1>
    <div id='profile' class='profile_container'>
      <div class='load_profile'>
        <select name='select_profile' id='select_profile' onchange='loadProfileFromLocalStorage();'>
          <option selected='selected' value='profile.default'>profile.default</option>
        </select>
        <input type='button' class='input_load_profile' value='Load Profile From Local Storage' onclick='loadProfileFromLocalStorage();' />
        <br />
        <br />
        Load from disk: <input type='file' class='input_delete_profile' value='Load Profile From File' onchange='loadProfileFromFile(this);' />
        <br />
        <br />
        <input type='button' class='input_delete_profile' value='delete profile' onclick='deleteProfile();' />
      </div>
      <div class='save_profile'>
        profile name: <input type='text' class='input_profile_name' id='input_profile_name' value='' />
        <input type='button' class='input_save_profile' value='Save Profile To Local Storage' onclick='saveProfileToLocalStorage();' />
        <textarea rows='0' cols='0' id='textarea_profile' class='textarea_profile'></textarea>
        <input type='button' class='input_save_profile' value='Save Profile To File' onclick='saveProfileToFile();' />
      </div>
    </div>
    <br />
    <div id='top' class='regex_pair'>
      <div class='pattern'>
        Pattern: <input class='input_pattern' value='' />
      </div>
      <div class='replace'>
        Replace: <input class='input_replace' value='' />
      </div>
    </div>
    <br />
    <div class='controls'>
      <div class='add_pattern'>
        <input type='button' value='add pattern +' id='button_new_pattern' onclick='buttonNewPattern()' />
      </div>
      <br />
      <div class='remove_pattern'>
        <input type='button' value='remove pattern -' id='button_new_pattern' onclick='buttonReplaceLastPattern()' />
      </div>
      <br />
      <div class='apply_pattern'>
        <input type='button' value='replace' id='button_replace' onclick='buttonExecutePatternReplace()' />
      </div>
    </div>
    <br />
    <div class='tool_container'>
      <div class='panel'>
        Source<br/>
        <textarea rows='10' cols='10' id='textarea_source' class='textarea_tool' ></textarea>
        <br />
        <input type='button' value='save' id='button_save_textarea_source' onclick='download("textarea_source");' />
      </div>
      <div class='panel'>
        Result<br/>
        <textarea rows='10' cols='10' id='textarea_result' class='textarea_tool'></textarea>
        <br />
        <input type='button' value='save' id='button_save_textarea_result' onclick='download("textarea_result");' />
      </div>
    </div>
  </body>
</html>
